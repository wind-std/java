<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>家庭记账本 - 注册</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f5f5f5;
      display: flex;
      justify-content: center;
      align-items: center;
      height: 100vh;
      margin: 0;
    }
    .register-container {
      background-color: white;
      padding: 30px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      width: 350px;
    }
    h1 {
      text-align: center;
      color: #333;
      margin-bottom: 30px;
    }
    .form-group {
      margin-bottom: 20px;
    }
    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }
    input, select {
      width: 100%;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    button {
      width: 100%;
      padding: 12px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
    }
    button:hover {
      background-color: #45a049;
    }
    .login-link {
      text-align: center;
      margin-top: 20px;
    }
    .login-link a {
      color: #4CAF50;
      text-decoration: none;
    }
    .error-message {
      color: red;
      margin-top: 10px;
      text-align: center;
    }
    .loading {
      text-align: center;
      color: #777;
      margin: 10px 0;
    }
  </style>
</head>
<body>
<div class="register-container">
  <h1>注册新账号</h1>
  <div class="form-group">
    <label for="username">用户名</label>
    <input type="text" id="username" placeholder="请输入用户名">
  </div>
  <div class="form-group">
    <label for="password">密码</label>
    <input type="password" id="password" placeholder="请输入密码">
  </div>
  <div class="form-group">
    <label for="nickname">昵称</label>
    <input type="text" id="nickname" placeholder="请输入昵称">
  </div>
  <div class="form-group">
    <label for="family-select">选择家庭</label>
    <select id="family-select" required>
      <option value="">加载中...</option>
    </select>
    <div id="family-loading" class="loading">正在加载家庭列表...</div>
  </div>
  <button id="register-btn">注册</button>
  <div class="login-link">
    已有账号？<a href="login.html">立即登录</a>
  </div>
  <div class="register-link">
    需要创建新家庭？<a href="register-admin.html">注册家庭主管账号</a>
  </div>
  <div id="error-message" class="error-message"></div>
</div>

<script>
  // 页面加载完成后执行
  document.addEventListener('DOMContentLoaded', function() {
    // 获取DOM元素
    const usernameInput = document.getElementById('username');
    const passwordInput = document.getElementById('password');
    const nicknameInput = document.getElementById('nickname');
    const familySelect = document.getElementById('family-select');
    const registerBtn = document.getElementById('register-btn');
    const errorElement = document.getElementById('error-message');
    const familyLoading = document.getElementById('family-loading');

    // 加载家庭列表
    loadFamilies();

    // 注册按钮点击事件
    registerBtn.addEventListener('click', function() {
      registerUser();
    });

    // 加载家庭列表函数
    function loadFamilies() {
      fetch('/api/user/families')
              .then(response => {
                if (!response.ok) {
                  throw new Error('网络响应不正常');
                }
                return response.json();
              })
              .then(data => {
                if (data.code === 200) {
                  // 清空现有选项
                  familySelect.innerHTML = '';

                  // 添加默认选项
                  const defaultOption = document.createElement('option');
                  defaultOption.value = '';
                  defaultOption.textContent = '请选择家庭';
                  defaultOption.selected = true;
                  defaultOption.disabled = true;
                  familySelect.appendChild(defaultOption);

                  // 添加家庭选项
                  data.data.forEach(family => {
                    const option = document.createElement('option');
                    option.value = family.id;
                    option.textContent = family.name;
                    familySelect.appendChild(option);
                  });

                  // 隐藏加载提示
                  familyLoading.style.display = 'none';
                } else {
                  showError('加载家庭列表失败: ' + data.message);
                }
              })
              .catch(error => {
                showError('加载家庭列表失败: ' + error.message);
                familyLoading.textContent = '加载家庭列表失败，请刷新重试';
              });
    }

    // 注册用户函数
    function registerUser() {
      const username = usernameInput.value.trim();
      const password = passwordInput.value.trim();
      const nickname = nicknameInput.value.trim();
      const familyId = familySelect.value;

      // 验证输入
      if (!username || !password || !nickname || !familyId) {
        showError('请填写所有字段');
        return;
      }

      // 禁用注册按钮防止重复提交
      registerBtn.disabled = true;
      registerBtn.textContent = '注册中...';

      // 准备注册数据
      const userData = {
        username: username,
        password: password,
        nickname: nickname,
        familyId: parseInt(familyId)
      };

      // 发送注册请求
      fetch('/api/user/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(userData)
      })
              .then(response => {
                if (!response.ok) {
                  throw new Error('网络响应不正常');
                }
                return response.json();
              })
              .then(data => {
                if (data.code === 200) {
                  // 注册成功，跳转到登录页面
                  window.location.href = 'login.html?registered=true';
                } else {
                  showError('注册失败: ' + data.message);
                  registerBtn.disabled = false;
                  registerBtn.textContent = '注册';
                }
              })
              .catch(error => {
                showError('注册失败: ' + error.message);
                registerBtn.disabled = false;
                registerBtn.textContent = '注册';
              });
    }

    // 显示错误信息函数
    function showError(message) {
      errorElement.textContent = message;
      setTimeout(() => {
        errorElement.textContent = '';
      }, 5000);
    }

    // 检查URL参数，显示注册成功的消息
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('registered') === 'true') {
      showError('注册成功，请等待管理员审核');
    }
  });
</script>
</body>
</html>