<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>å®¶åº­è®°è´¦æœ¬ - é¦–é¡µ</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 0;
      background-color: #f5f5f5;
    }
    .container {
      display: flex;
      min-height: 100vh;
    }
    .sidebar {
      width: 250px;
      background-color: #2c3e50;
      color: white;
      padding: 20px 0;
    }
    .sidebar-header {
      padding: 0 20px 20px;
      border-bottom: 1px solid #34495e;
    }
    .sidebar-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .sidebar-header p {
      margin: 5px 0 0;
      font-size: 14px;
      color: #bdc3c7;
    }
    .nav-menu {
      list-style: none;
      padding: 0;
      margin: 20px 0;
    }
    .nav-menu li a {
      display: block;
      padding: 12px 20px;
      color: #bdc3c7;
      text-decoration: none;
      transition: all 0.3s;
    }
    .nav-menu li a:hover, .nav-menu li a.active {
      background-color: #34495e;
      color: white;
    }
    .nav-menu li a i {
      margin-right: 10px;
    }
    .main-content {
      flex: 1;
      padding: 20px;
      background-color: #ecf0f1;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 20px;
      border-bottom: 1px solid #ddd;
    }
    .header h1 {
      margin: 0;
      font-size: 24px;
      color: #2c3e50;
    }
    .user-info {
      display: flex;
      align-items: center;
    }
    .user-info img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      margin-right: 10px;
    }
    .user-name {
      margin-right: 15px;
      font-weight: bold;
    }
    .logout-btn {
      background: none;
      border: none;
      color: #e74c3c;
      cursor: pointer;
      font-size: 14px;
    }
    .card {
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin-bottom: 20px;
    }
    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .card-header h2 {
      margin: 0;
      font-size: 18px;
      color: #2c3e50;
    }
    .btn {
      padding: 8px 15px;
      background-color: #3498db;
      color: white;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
    }
    .btn:hover {
      background-color: #2980b9;
    }
    .btn-danger {
      background-color: #e74c3c;
    }
    .btn-danger:hover {
      background-color: #c0392b;
    }
    .btn-success {
      background-color: #2ecc71;
    }
    .btn-success:hover {
      background-color: #27ae60;
    }
    table {
      width: 100%;
      border-collapse: collapse;
    }
    table th, table td {
      padding: 12px 15px;
      text-align: left;
      border-bottom: 1px solid #ddd;
    }
    table th {
      background-color: #f8f9fa;
      font-weight: bold;
    }
    table tr:hover {
      background-color: #f5f5f5;
    }
    .badge {
      display: inline-block;
      padding: 3px 7px;
      font-size: 12px;
      font-weight: bold;
      line-height: 1;
      color: white;
      text-align: center;
      white-space: nowrap;
      vertical-align: middle;
      border-radius: 10px;
    }
    .badge-income {
      background-color: #2ecc71;
    }
    .badge-expense {
      background-color: #e74c3c;
    }
    .form-group {
      margin-bottom: 15px;
    }
    .form-group label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .form-row {
      display: flex;
      gap: 15px;
    }
    .form-row .form-group {
      flex: 1;
    }
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
    }
    .modal-content {
      background-color: white;
      margin: 10% auto;
      padding: 20px;
      border-radius: 5px;
      width: 50%;
      max-width: 600px;
    }
    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 10px;
      border-bottom: 1px solid #eee;
    }
    .modal-header h2 {
      margin: 0;
      font-size: 20px;
    }
    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
    }
    .modal-footer {
      display: flex;
      justify-content: flex-end;
      gap: 10px;
      margin-top: 20px;
      padding-top: 10px;
      border-top: 1px solid #eee;
    }
    .summary-card {
      display: flex;
      justify-content: space-between;
      margin-bottom: 20px;
    }
    .summary-item {
      flex: 1;
      padding: 15px;
      background-color: white;
      border-radius: 5px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      margin-right: 15px;
    }
    .summary-item:last-child {
      margin-right: 0;
    }
    .summary-title {
      font-size: 14px;
      color: #7f8c8d;
      margin-bottom: 10px;
    }
    .summary-value {
      font-size: 24px;
      font-weight: bold;
    }
    .summary-income {
      color: #2ecc71;
    }
    .summary-expense {
      color: #e74c3c;
    }
    .summary-balance {
      color: #3498db;
    }
    .chart-container {
      height: 300px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body>
<div class="container">
  <!-- ä¾§è¾¹æ  -->
  <div class="sidebar">
    <div class="sidebar-header">
      <h2>å®¶åº­è®°è´¦æœ¬</h2>
      <p id="current-family">å®¶åº­åç§°åŠ è½½ä¸­...</p>
    </div>
    <ul class="nav-menu">
      <li><a href="#" class="active" data-page="dashboard"><i>ğŸ“Š</i> æ”¶æ”¯æ¦‚è§ˆ</a></li>
      <li><a href="#" data-page="records"><i>ğŸ“</i> æ”¶æ”¯è®°å½•</a></li>
      <li><a href="#" data-page="add-record"><i>â•</i> æ·»åŠ è®°å½•</a></li>
      <li><a href="#" data-page="reports"><i>ğŸ“ˆ</i> æ”¶æ”¯æŠ¥è¡¨</a></li>
      <li><a href="#" data-page="account"><i>ğŸ‘¤</i> ä¸ªäººè´¦å·</a></li>
      <li id="family-management-link" style="display: none;"><a href="#" data-page="family-management"><i>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§â€ğŸ‘¦</i> å®¶åº­ç®¡ç†</a></li>
    </ul>
  </div>

  <!-- ä¸»å†…å®¹åŒº -->
  <div class="main-content">
    <div class="header">
      <h1 id="page-title">æ”¶æ”¯æ¦‚è§ˆ</h1>
      <div class="user-info">
        <span class="user-name" id="current-user">åŠ è½½ä¸­...</span>
        <button class="logout-btn" id="logout-btn">é€€å‡ºç™»å½•</button>
      </div>
    </div>

    <!-- ä»ªè¡¨ç›˜é¡µé¢ -->
    <div id="dashboard-page" class="page-content">
      <div class="summary-card">
        <div class="summary-item">
          <div class="summary-title">æœ¬æœˆæ”¶å…¥</div>
          <div class="summary-value summary-income" id="month-income">Â¥0.00</div>
        </div>
        <div class="summary-item">
          <div class="summary-title">æœ¬æœˆæ”¯å‡º</div>
          <div class="summary-value summary-expense" id="month-expense">Â¥0.00</div>
        </div>
        <div class="summary-item">
          <div class="summary-title">æœ¬æœˆç»“ä½™</div>
          <div class="summary-value summary-balance" id="month-balance">Â¥0.00</div>
        </div>
      </div>

      <div class="card">
        <div class="card-header">
          <h2>æœ€è¿‘æ”¶æ”¯è®°å½•</h2>
          <button class="btn" id="view-all-records">æŸ¥çœ‹å…¨éƒ¨</button>
        </div>
        <table id="recent-records">
          <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>ç±»å‹</th>
            <th>é‡‘é¢</th>
            <th>åˆ†ç±»</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œäºº</th>
          </tr>
          </thead>
          <tbody>
          <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ”¶æ”¯è®°å½•é¡µé¢ -->
    <div id="records-page" class="page-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h2>æ”¶æ”¯è®°å½•</h2>
          <div>
            <select id="record-year">
              <!-- åŠ¨æ€åŠ è½½å¹´ä»½ -->
            </select>
            <select id="record-month">
              <option value="0">å…¨å¹´</option>
              <option value="1">1æœˆ</option>
              <!-- å…¶ä»–æœˆä»½ -->
            </select>
            <button class="btn" id="filter-records">ç­›é€‰</button>
          </div>
        </div>
        <table id="all-records">
          <thead>
          <tr>
            <th>æ—¥æœŸ</th>
            <th>ç±»å‹</th>
            <th>é‡‘é¢</th>
            <th>åˆ†ç±»</th>
            <th>å¤‡æ³¨</th>
            <th>æ“ä½œäºº</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody>
          <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- æ·»åŠ è®°å½•é¡µé¢ -->
    <div id="add-record-page" class="page-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h2>æ·»åŠ æ”¶æ”¯è®°å½•</h2>
        </div>
        <form id="add-record-form">
          <div class="form-row">
            <div class="form-group">
              <label for="record-type">ç±»å‹</label>
              <select id="record-type" required>
                <option value="INCOME">æ”¶å…¥</option>
                <option value="EXPENSE">æ”¯å‡º</option>
              </select>
            </div>
            <div class="form-group">
              <label for="record-amount">é‡‘é¢</label>
              <input type="number" id="record-amount" step="0.01" min="0" required>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="record-category">åˆ†ç±»</label>
              <select id="record-category" required>
                <option value="å·¥èµ„">å·¥èµ„</option>
                <option value="å¥–é‡‘">å¥–é‡‘</option>
                <option value="æŠ•èµ„">æŠ•èµ„</option>
                <option value="é¤é¥®">é¤é¥®</option>
                <option value="è´­ç‰©">è´­ç‰©</option>
                <option value="äº¤é€š">äº¤é€š</option>
                <option value="å¨±ä¹">å¨±ä¹</option>
                <option value="å…¶ä»–">å…¶ä»–</option>
              </select>
            </div>
            <div class="form-group">
              <label for="record-date">æ—¥æœŸ</label>
              <input type="date" id="record-date" required>
            </div>
          </div>
          <div class="form-group">
            <label for="record-description">å¤‡æ³¨</label>
            <textarea id="record-description" rows="3"></textarea>
          </div>
          <div class="form-group">
            <button type="submit" class="btn btn-success">æ·»åŠ è®°å½•</button>
          </div>
        </form>
      </div>
    </div>

    <!-- æ”¶æ”¯æŠ¥è¡¨é¡µé¢ -->
    <div id="reports-page" class="page-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h2>æ”¶æ”¯æŠ¥è¡¨</h2>
          <div>
            <select id="report-type">
              <option value="month">æœˆåº¦æŠ¥è¡¨</option>
              <option value="year">å¹´åº¦æŠ¥è¡¨</option>
            </select>
            <select id="report-year">
              <!-- åŠ¨æ€åŠ è½½å¹´ä»½ -->
            </select>
            <select id="report-month">
              <option value="1">1æœˆ</option>
              <!-- å…¶ä»–æœˆä»½ -->
            </select>
            <button class="btn" id="generate-report">ç”ŸæˆæŠ¥è¡¨</button>
          </div>
        </div>
        <div class="chart-container">
          <canvas id="report-chart"></canvas>
        </div>
        <table id="report-table">
          <thead>
          <tr>
            <th>åˆ†ç±»</th>
            <th>æ”¶å…¥</th>
            <th>æ”¯å‡º</th>
            <th>å‡€é¢</th>
          </tr>
          </thead>
          <tbody>
          <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- ä¸ªäººè´¦å·é¡µé¢ -->
    <div id="account-page" class="page-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h2>ä¸ªäººè´¦å·ç®¡ç†</h2>
        </div>
        <form id="account-form">
          <div class="form-group">
            <label for="account-username">ç”¨æˆ·å</label>
            <input type="text" id="account-username" readonly>
          </div>
          <div class="form-group">
            <label for="account-nickname">æ˜µç§°</label>
            <input type="text" id="account-nickname" required>
          </div>
          <div class="form-group">
            <label for="account-current-password">å½“å‰å¯†ç </label>
            <input type="password" id="account-current-password">
          </div>
          <div class="form-group">
            <label for="account-new-password">æ–°å¯†ç </label>
            <input type="password" id="account-new-password">
          </div>
          <div class="form-group">
            <label for="account-confirm-password">ç¡®è®¤æ–°å¯†ç </label>
            <input type="password" id="account-confirm-password">
          </div>
          <div class="form-group">
            <button type="submit" class="btn">ä¿å­˜æ›´æ”¹</button>
          </div>
        </form>
      </div>
    </div>

    <!-- å®¶åº­ç®¡ç†é¡µé¢ -->
    <div id="family-management-page" class="page-content" style="display: none;">
      <div class="card">
        <div class="card-header">
          <h2>å®¶åº­æˆå‘˜ç®¡ç†</h2>
        </div>
        <table id="family-members">
          <thead>
          <tr>
            <th>ç”¨æˆ·å</th>
            <th>æ˜µç§°</th>
            <th>è§’è‰²</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody>
          <!-- åŠ¨æ€åŠ è½½æ•°æ® -->
          </tbody>
        </table>
      </div>
      <div class="card">
        <div class="card-header">
          <h2>å¾…å®¡æ ¸æˆå‘˜</h2>
        </div>
        <table id="pending-members">
          <thead>
          <tr>
            <th>ç”¨æˆ·å</th>
            <th>æ˜µç§°</th>
            <th>ç”³è¯·åŠ å…¥å®¶åº­</th>
            <th>ç”³è¯·æ—¶é—´</th>
            <th>æ“ä½œ</th>
          </tr>
          </thead>
          <tbody>
          <!-- åŠ¨æ€åŠ è½½ -->
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- ç¼–è¾‘è®°å½•æ¨¡æ€æ¡† -->
<div id="edit-record-modal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h2>ç¼–è¾‘æ”¶æ”¯è®°å½•</h2>
      <button class="close-btn">&times;</button>
    </div>
    <form id="edit-record-form">
      <input type="hidden" id="edit-record-id">
      <div class="form-row">
        <div class="form-group">
          <label for="edit-record-type">ç±»å‹</label>
          <select id="edit-record-type" required>
            <option value="INCOME">æ”¶å…¥</option>
            <option value="EXPENSE">æ”¯å‡º</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-record-amount">é‡‘é¢</label>
          <input type="number" id="edit-record-amount" step="0.01" min="0" required>
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label for="edit-record-category">åˆ†ç±»</label>
          <select id="edit-record-category" required>
            <option value="å·¥èµ„">å·¥èµ„</option>
            <option value="å¥–é‡‘">å¥–é‡‘</option>
            <option value="æŠ•èµ„">æŠ•èµ„</option>
            <option value="é¤é¥®">é¤é¥®</option>
            <option value="è´­ç‰©">è´­ç‰©</option>
            <option value="äº¤é€š">äº¤é€š</option>
            <option value="å¨±ä¹">å¨±ä¹</option>
            <option value="å…¶ä»–">å…¶ä»–</option>
          </select>
        </div>
        <div class="form-group">
          <label for="edit-record-date">æ—¥æœŸ</label>
          <input type="date" id="edit-record-date" required>
        </div>
      </div>
      <div class="form-group">
        <label for="edit-record-description">å¤‡æ³¨</label>
        <textarea id="edit-record-description" rows="3"></textarea>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-danger" id="delete-record-btn">åˆ é™¤è®°å½•</button>
        <button type="submit" class="btn">ä¿å­˜æ›´æ”¹</button>
      </div>
    </form>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // å…¨å±€å˜é‡
  let currentUser = null;
  let isAdmin = false;
  let reportChart = null;
  let familyList = []; // å­˜å‚¨å®¶åº­åˆ—è¡¨

  // DOMåŠ è½½å®Œæˆåæ‰§è¡Œ
  document.addEventListener('DOMContentLoaded', function() {
    // æ£€æŸ¥ç™»å½•çŠ¶æ€
    checkLoginStatus();

    // åˆå§‹åŒ–é¡µé¢
    initPage();

    // ç»‘å®šäº‹ä»¶
    bindEvents();

    // åŠ è½½å®¶åº­åˆ—è¡¨ï¼ˆç”¨äºæ³¨å†Œå®¡æ ¸ï¼‰
    loadFamilyList();
  });

  // æ£€æŸ¥ç™»å½•çŠ¶æ€
  function checkLoginStatus() {
    fetch('/api/user/current')
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                currentUser = data.data;
                isAdmin = currentUser.role === 'ADMIN';
                updateUserInfo();
                loadDashboardData();

                // å¦‚æœæ˜¯ç®¡ç†å‘˜ï¼Œæ˜¾ç¤ºå®¶åº­ç®¡ç†èœå•
                if (isAdmin) {
                  document.getElementById('family-management-link').style.display = 'block';
                  // åŠ è½½å¾…å®¡æ ¸æˆå‘˜
                  loadPendingMembers();
                }
              } else {
                // æœªç™»å½•ï¼Œè·³è½¬åˆ°ç™»å½•é¡µé¢
                window.location.href = 'login.html';
              }
            })
            .catch(error => {
              console.error('Error:', error);
              window.location.href = 'login.html';
            });
  }

  // åŠ è½½å®¶åº­åˆ—è¡¨
  function loadFamilyList() {
    fetch('/api/user/families')
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                familyList = data.data;
                // æ›´æ–°æ³¨å†Œé¡µé¢çš„å®¶åº­é€‰æ‹©å™¨ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
                const familySelect = document.getElementById('family-select');
                if (familySelect) {
                  familySelect.innerHTML = '';
                  data.data.forEach(family => {
                    const option = document.createElement('option');
                    option.value = family.id;
                    option.textContent = family.name;
                    familySelect.appendChild(option);
                  });
                }
              }
            })
            .catch(error => {
              console.error('åŠ è½½å®¶åº­åˆ—è¡¨å¤±è´¥:', error);
            });
  }

  // åŠ è½½å¾…å®¡æ ¸æˆå‘˜ï¼ˆç®¡ç†å‘˜ä¸“ç”¨ï¼‰
  function loadPendingMembers() {
    fetch('/api/user/pending-members')
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                updatePendingMembersTable(data.data);
              }
            })
            .catch(error => {
              console.error('åŠ è½½å¾…å®¡æ ¸æˆå‘˜å¤±è´¥:', error);
            });
  }

  // æ›´æ–°å¾…å®¡æ ¸æˆå‘˜è¡¨æ ¼
  function updatePendingMembersTable(members) {
    const tbody = document.querySelector('#pending-members tbody');
    tbody.innerHTML = '';

    if (members.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="5" style="text-align: center;">æš‚æ— å¾…å®¡æ ¸æˆå‘˜</td>';
      tbody.appendChild(row);
      return;
    }

    members.forEach(member => {
      const row = document.createElement('tr');
      const registerDate = new Date(member.createTime);
      const formattedDate = `${registerDate.getFullYear()}-${(registerDate.getMonth() + 1).toString().padStart(2, '0')}-${registerDate.getDate().toString().padStart(2, '0')}`;

      row.innerHTML = `
                <td>${member.username}</td>
                <td>${member.nickname}</td>
                <td>${familyList.find(f => f.id === member.familyId)?.name || member.familyId}</td>
                <td>${formattedDate}</td>
                <td>
                    <button class="btn btn-success approve-btn" data-id="${member.id}">æ‰¹å‡†</button>
                    <button class="btn btn-danger reject-btn" data-id="${member.id}">æ‹’ç»</button>
                </td>
            `;
      tbody.appendChild(row);
    });

    // ç»‘å®šæ‰¹å‡†/æ‹’ç»æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.approve-btn').forEach(btn => {
      btn.addEventListener('click', () => processMemberApplication(btn.dataset.id, true));
    });

    document.querySelectorAll('.reject-btn').forEach(btn => {
      btn.addEventListener('click', () => processMemberApplication(btn.dataset.id, false));
    });
  }

  // å¤„ç†æˆå‘˜å®¡æ ¸
  function processMemberApplication(userId, approve) {
    if (!confirm(`ç¡®å®šè¦${approve ? 'æ‰¹å‡†' : 'æ‹’ç»'}è¯¥æˆå‘˜çš„ç”³è¯·å—ï¼Ÿ`)) {
      return;
    }

    fetch(`/api/user/approve-member/${userId}?approve=${approve}`, {
      method: 'POST'
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                alert(`å·²${approve ? 'æ‰¹å‡†' : 'æ‹’ç»'}æˆå‘˜ç”³è¯·`);
                loadPendingMembers();
                loadFamilyMembers(); // åˆ·æ–°å®¶åº­æˆå‘˜åˆ—è¡¨
              } else {
                alert(`æ“ä½œå¤±è´¥: ${data.message}`);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('æ“ä½œå¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
  }

  // åˆå§‹åŒ–é¡µé¢å…ƒç´ 
  function initPage() {
    // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
    initDatePickers();

    // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
    initDateSelectors();

    // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºä»Šå¤©
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('record-date').value = today;
  }

  // åˆå§‹åŒ–æ—¥æœŸé€‰æ‹©å™¨
  function initDatePickers() {
    const dateInputs = document.querySelectorAll('input[type="date"]');
    const today = new Date().toISOString().split('T')[0];

    dateInputs.forEach(input => {
      input.value = today;
      input.max = today; // ä¸èƒ½é€‰æ‹©æœªæ¥çš„æ—¥æœŸ
    });
  }

  // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨
  function initYearSelectors() {
    const currentYear = new Date().getFullYear();
    const yearSelectors = [
      document.getElementById('record-year'),
      document.getElementById('report-year')
    ];

    yearSelectors.forEach(selector => {
      if (selector) {
        // æ·»åŠ æœ€è¿‘5å¹´çš„é€‰é¡¹
        for (let year = currentYear; year >= currentYear - 4; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year + 'å¹´';
          selector.appendChild(option);
        }

        // è®¾ç½®é»˜è®¤å€¼ä¸ºå½“å‰å¹´ä»½
        selector.value = currentYear;
      }
    });

    // åˆå§‹åŒ–æœˆä»½é€‰æ‹©å™¨
    const monthSelectors = [
      document.getElementById('record-month'),
      document.getElementById('report-month')
    ];

    monthSelectors.forEach(selector => {
      if (selector) {
        // è®¾ç½®é»˜è®¤å€¼ä¸ºå½“å‰æœˆä»½
        const currentMonth = new Date().getMonth() + 1;
        selector.value = currentMonth;
      }
    });
  }

  // ç»‘å®šäº‹ä»¶
  function bindEvents() {
    // å…³é—­æ¨¡æ€æ¡†æŒ‰é’®
    document.querySelector('.modal .close-btn').addEventListener('click', function() {
      document.getElementById('edit-record-modal').style.display = 'none';
    });

    // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
    window.addEventListener('click', function(e) {
      const modal = document.getElementById('edit-record-modal');
      if (e.target === modal) {
        modal.style.display = 'none';
      }
    });

    // ç¼–è¾‘è®°å½•è¡¨å•æäº¤
    document.getElementById('edit-record-form').addEventListener('submit', function(e) {
      e.preventDefault();
      updateRecord();
    });

    // åˆ é™¤è®°å½•æŒ‰é’®
    document.getElementById('delete-record-btn').addEventListener('click', function() {
      deleteRecord();
    });

    // å¯¼èˆªèœå•ç‚¹å‡»äº‹ä»¶
    document.querySelectorAll('.nav-menu a').forEach(link => {
      link.addEventListener('click', function(e) {
        e.preventDefault();

        // ç§»é™¤æ‰€æœ‰activeç±»
        document.querySelectorAll('.nav-menu a').forEach(item => {
          item.classList.remove('active');
        });

        // æ·»åŠ activeç±»åˆ°å½“å‰ç‚¹å‡»çš„é“¾æ¥
        this.classList.add('active');

        // æ˜¾ç¤ºå¯¹åº”çš„é¡µé¢
        const pageId = this.getAttribute('data-page') + '-page';
        document.querySelectorAll('.page-content').forEach(page => {
          page.style.display = 'none';
        });
        document.getElementById(pageId).style.display = 'block';

        // æ›´æ–°é¡µé¢æ ‡é¢˜
        document.getElementById('page-title').textContent = this.textContent.trim();

        // æ ¹æ®éœ€è¦åŠ è½½æ•°æ®
        switch (this.getAttribute('data-page')) {
          case 'dashboard':
            loadDashboardData();
            break;
          case 'records':
            loadRecordsData();
            break;
          case 'reports':
            loadReportData();
            break;
          case 'family-management':
            if (isAdmin) {
              loadFamilyMembers();
              loadPendingMembers();
            }
            break;
        }
      });
    });

    // é€€å‡ºç™»å½•æŒ‰é’®
    document.getElementById('logout-btn').addEventListener('click', function() {
      fetch('/api/user/logout', {
        method: 'POST'
      })
              .then(response => response.json())
              .then(data => {
                if (data.code === 200) {
                  window.location.href = 'login.html';
                }
              })
              .catch(error => {
                console.error('Error:', error);
              });
    });

    // æ·»åŠ è®°å½•è¡¨å•æäº¤
    document.getElementById('add-record-form').addEventListener('submit', function(e) {
      e.preventDefault();
      addNewRecord();
    });

    // æŸ¥çœ‹å…¨éƒ¨è®°å½•æŒ‰é’®
    document.getElementById('view-all-records').addEventListener('click', function() {
      // åˆ‡æ¢åˆ°è®°å½•é¡µé¢
      document.querySelector('.nav-menu a[data-page="records"]').click();
    });

    // ç­›é€‰è®°å½•æŒ‰é’®
    document.getElementById('filter-records').addEventListener('click', function() {
      loadRecordsData();
    });

    // ç”ŸæˆæŠ¥è¡¨æŒ‰é’®
    document.getElementById('generate-report').addEventListener('click', function() {
      loadReportData();
    });

    // ä¸ªäººè´¦å·è¡¨å•æäº¤
    document.getElementById('account-form').addEventListener('submit', function(e) {
      e.preventDefault();
      updateAccountInfo();
    });

    // æŠ¥è¡¨ç±»å‹åˆ‡æ¢äº‹ä»¶
    document.getElementById('report-type').addEventListener('change', function() {
      const monthSelector = document.getElementById('report-month');
      monthSelector.style.display = this.value === 'month' ? 'block' : 'none';
    });
  }
  // åŠ è½½ä»ªè¡¨ç›˜æ•°æ®
  function loadDashboardData() {
    const currentDate = new Date();
    const year = currentDate.getFullYear();
    const month = currentDate.getMonth() + 1;

    // è·å–æœ¬æœˆæ”¶æ”¯è®°å½•
    fetch(`/api/record/month/${year}/${month}`)
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                const records = data.data;
                updateRecentRecordsTable(records.slice(0, 5)); // åªæ˜¾ç¤ºæœ€è¿‘5æ¡è®°å½•

                // è®¡ç®—æœ¬æœˆæ”¶å…¥å’Œæ”¯å‡º
                let income = 0;
                let expense = 0;

                records.forEach(record => {
                  if (record.type === 'INCOME') {
                    income += record.amount;
                  } else {
                    expense += record.amount;
                  }
                });

                // æ›´æ–°æ‘˜è¦å¡ç‰‡
                document.getElementById('month-income').textContent = 'Â¥' + income.toFixed(2);
                document.getElementById('month-expense').textContent = 'Â¥' + expense.toFixed(2);
                document.getElementById('month-balance').textContent = 'Â¥' + (income - expense).toFixed(2);
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
  }

  // æ›´æ–°æœ€è¿‘è®°å½•è¡¨æ ¼
  function updateRecentRecordsTable(records) {
    const tbody = document.querySelector('#recent-records tbody');
    tbody.innerHTML = '';

    if (records.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="6" style="text-align: center;">æš‚æ— è®°å½•</td>';
      tbody.appendChild(row);
      return;
    }

    records.forEach(record => {
      const row = document.createElement('tr');

      // æ ¼å¼åŒ–æ—¥æœŸ
      const recordDate = new Date(record.recordDate);
      const formattedDate = `${recordDate.getFullYear()}-${(recordDate.getMonth() + 1).toString().padStart(2, '0')}-${recordDate.getDate().toString().padStart(2, '0')}`;

      // æ ¼å¼åŒ–ç±»å‹
      const typeBadge = record.type === 'INCOME' ?
              '<span class="badge badge-income">æ”¶å…¥</span>' :
              '<span class="badge badge-expense">æ”¯å‡º</span>';

      row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${typeBadge}</td>
                    <td>Â¥${record.amount.toFixed(2)}</td>
                    <td>${record.category}</td>
                    <td>${record.description || '-'}</td>
                    <td>${record.nickname}</td>
                `;

      tbody.appendChild(row);
    });
  }

  // åŠ è½½è®°å½•æ•°æ®
  function loadRecordsData() {
    const year = parseInt(document.getElementById('record-year').value);
    const month = parseInt(document.getElementById('record-month').value);

    let url = `/api/record/year/${year}`;
    if (month > 0) {
      url = `/api/record/month/${year}/${month}`;
    }

    fetch(url)
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                updateAllRecordsTable(data.data);
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
  }

  // æ›´æ–°æ‰€æœ‰è®°å½•è¡¨æ ¼
  function updateAllRecordsTable(records) {
    const tbody = document.querySelector('#all-records tbody');
    tbody.innerHTML = '';

    if (records.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = '<td colspan="7" style="text-align: center;">æš‚æ— è®°å½•</td>';
      tbody.appendChild(row);
      return;
    }

    records.forEach(record => {
      const row = document.createElement('tr');

      // æ ¼å¼åŒ–æ—¥æœŸ
      const recordDate = new Date(record.recordDate);
      const formattedDate = `${recordDate.getFullYear()}-${(recordDate.getMonth() + 1).toString().padStart(2, '0')}-${recordDate.getDate().toString().padStart(2, '0')}`;

      // æ ¼å¼åŒ–ç±»å‹
      const typeBadge = record.type === 'INCOME' ?
              '<span class="badge badge-income">æ”¶å…¥</span>' :
              '<span class="badge badge-expense">æ”¯å‡º</span>';

      row.innerHTML = `
                    <td>${formattedDate}</td>
                    <td>${typeBadge}</td>
                    <td>Â¥${record.amount.toFixed(2)}</td>
                    <td>${record.category}</td>
                    <td>${record.description || '-'}</td>
                    <td>${record.nickname}</td>
                    <td>
                        <button class="btn edit-record-btn" data-id="${record.id}">ç¼–è¾‘</button>
                    </td>
                `;

      tbody.appendChild(row);
    });

    // ç»‘å®šç¼–è¾‘æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.edit-record-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const recordId = parseInt(this.getAttribute('data-id'));
        showEditRecordModal(recordId);
      });
    });
  }

  // æ·»åŠ æ–°è®°å½•
  function addNewRecord() {
    const record = {
      type: document.getElementById('record-type').value,
      amount: parseFloat(document.getElementById('record-amount').value),
      category: document.getElementById('record-category').value,
      description: document.getElementById('record-description').value,
      recordDate: document.getElementById('record-date').value
    };

    fetch('/api/record/add', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(record)
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                alert('è®°å½•æ·»åŠ æˆåŠŸ');
                document.getElementById('add-record-form').reset();
                loadDashboardData();
              } else {
                alert('æ·»åŠ å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('æ·»åŠ å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
  }

  // æ˜¾ç¤ºç¼–è¾‘è®°å½•æ¨¡æ€æ¡†
  function showEditRecordModal(recordId) {
    fetch(`/api/record/get/${recordId}`)
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                const record = data.data;

                // å¡«å……è¡¨å•
                document.getElementById('edit-record-id').value = record.id;
                document.getElementById('edit-record-type').value = record.type;
                document.getElementById('edit-record-amount').value = record.amount;
                document.getElementById('edit-record-category').value = record.category;
                document.getElementById('edit-record-description').value = record.description || '';

                // æ ¼å¼åŒ–æ—¥æœŸ
                const recordDate = new Date(record.recordDate);
                const formattedDate = `${recordDate.getFullYear()}-${(recordDate.getMonth() + 1).toString().padStart(2, '0')}-${recordDate.getDate().toString().padStart(2, '0')}`;
                document.getElementById('edit-record-date').value = formattedDate;

                // æ˜¾ç¤ºæ¨¡æ€æ¡†
                document.getElementById('edit-record-modal').style.display = 'block';

                // å¦‚æœä¸æ˜¯ç®¡ç†å‘˜ï¼Œéšè—åˆ é™¤æŒ‰é’®
                if (!isAdmin) {
                  document.getElementById('delete-record-btn').style.display = 'none';
                } else {
                  document.getElementById('delete-record-btn').style.display = 'block';
                }
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
  }

  // æ›´æ–°è®°å½•
  function updateRecord() {
    console.log("è¡¨å•æäº¤è§¦å‘");
    const record = {
      id: parseInt(document.getElementById('edit-record-id').value),
      type: document.getElementById('edit-record-type').value,
      amount: parseFloat(document.getElementById('edit-record-amount').value),
      category: document.getElementById('edit-record-category').value,
      description: document.getElementById('edit-record-description').value,
      recordDate: document.getElementById('edit-record-date').value
    };

    fetch('/api/record/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(record)
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                alert('è®°å½•æ›´æ–°æˆåŠŸ');
                document.getElementById('edit-record-modal').style.display = 'none';
                loadRecordsData();

              } else {
                alert('æ›´æ–°å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
  }

  // åˆ é™¤è®°å½•
  function deleteRecord() {
    const recordId = parseInt(document.getElementById('edit-record-id').value);

    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™æ¡è®°å½•å—ï¼Ÿ')) {
      return;
    }

    fetch(`/api/record/delete/${recordId}`, {
      method: 'POST'
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                alert('è®°å½•åˆ é™¤æˆåŠŸ');
                document.getElementById('edit-record-modal').style.display = 'none';
                loadRecordsData();
                loadDashboardData();
              } else {
                alert('åˆ é™¤å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('åˆ é™¤å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
  }

  // åŠ è½½æŠ¥è¡¨æ•°æ®
  function loadReportData() {
    const reportType = document.getElementById('report-type').value;
    const year = parseInt(document.getElementById('report-year').value);
    const month = parseInt(document.getElementById('report-month').value);

    let url = `/api/record/summary/year/${year}`;
    if (reportType === 'month') {
      url = `/api/record/summary/month/${year}/${month}`;
    }

    fetch(url)
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                updateReport(data.data, reportType);
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
  }

  // æ›´æ–°æŠ¥è¡¨
  function updateReport(summaryData, reportType) {
    // å‡†å¤‡æ•°æ®
    const categories = [];
    const incomeData = [];
    const expenseData = [];

    // æŒ‰åˆ†ç±»æ±‡æ€»
    const categoryMap = {};

    summaryData.forEach(item => {
      if (!categoryMap[item.category]) {
        categoryMap[item.category] = {
          income: 0,
          expense: 0
        };
      }

      if (item.type === 'INCOME') {
        categoryMap[item.category].income += item.amount;
      } else {
        categoryMap[item.category].expense += item.amount;
      }
    });

    // å¡«å……æ•°æ®
    for (const category in categoryMap) {
      categories.push(category);
      incomeData.push(categoryMap[category].income);
      expenseData.push(categoryMap[category].expense);
    }

    // æ›´æ–°è¡¨æ ¼
    updateReportTable(categoryMap);

    // æ›´æ–°å›¾è¡¨
    updateReportChart(categories, incomeData, expenseData, reportType);
  }

  // æ›´æ–°æŠ¥è¡¨è¡¨æ ¼
  function updateReportTable(categoryMap) {
    const tbody = document.querySelector('#report-table tbody');
    tbody.innerHTML = '';

    let totalIncome = 0;
    let totalExpense = 0;

    for (const category in categoryMap) {
      const row = document.createElement('tr');
      const income = categoryMap[category].income;
      const expense = categoryMap[category].expense;
      const net = income - expense;

      totalIncome += income;
      totalExpense += expense;

      row.innerHTML = `
                    <td>${category}</td>
                    <td>${income > 0 ? 'Â¥' + income.toFixed(2) : '-'}</td>
                    <td>${expense > 0 ? 'Â¥' + expense.toFixed(2) : '-'}</td>
                    <td>Â¥${net.toFixed(2)}</td>
                `;

      tbody.appendChild(row);
    }

    // æ·»åŠ æ€»è®¡è¡Œ
    const totalRow = document.createElement('tr');
    totalRow.style.fontWeight = 'bold';
    totalRow.innerHTML = `
                <td>æ€»è®¡</td>
                <td>Â¥${totalIncome.toFixed(2)}</td>
                <td>Â¥${totalExpense.toFixed(2)}</td>
                <td>Â¥${(totalIncome - totalExpense).toFixed(2)}</td>
            `;
    tbody.appendChild(totalRow);
  }

  // æ›´æ–°æŠ¥è¡¨å›¾è¡¨
  function updateReportChart(categories, incomeData, expenseData, reportType) {
    const ctx = document.getElementById('report-chart').getContext('2d');

    // é”€æ¯ä¹‹å‰çš„å›¾è¡¨
    if (reportChart) {
      reportChart.destroy();
    }

    reportChart = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: categories,
        datasets: [
          {
            label: 'æ”¶å…¥',
            data: incomeData,
            backgroundColor: 'rgba(46, 204, 113, 0.7)',
            borderColor: 'rgba(46, 204, 113, 1)',
            borderWidth: 1
          },
          {
            label: 'æ”¯å‡º',
            data: expenseData,
            backgroundColor: 'rgba(231, 76, 60, 0.7)',
            borderColor: 'rgba(231, 76, 60, 1)',
            borderWidth: 1
          }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          y: {
            beginAtZero: true
          }
        },
        plugins: {
          title: {
            display: true,
            text: reportType === 'month' ? 'æœˆåº¦æ”¶æ”¯æŠ¥è¡¨' : 'å¹´åº¦æ”¶æ”¯æŠ¥è¡¨'
          }
        }
      }
    });
  }

  // æ›´æ–°ä¸ªäººè´¦å·ä¿¡æ¯
  function updateAccountInfo() {
    const currentPassword = document.getElementById('account-current-password').value;
    const newPassword = document.getElementById('account-new-password').value;
    const confirmPassword = document.getElementById('account-confirm-password').value;

    // éªŒè¯å¯†ç 
    if (newPassword && newPassword !== confirmPassword) {
      alert('æ–°å¯†ç å’Œç¡®è®¤å¯†ç ä¸ä¸€è‡´');
      return;
    }

    const user = {
      nickname: document.getElementById('account-nickname').value
    };

    // å¦‚æœæœ‰æ–°å¯†ç ï¼Œéœ€è¦éªŒè¯å½“å‰å¯†ç 
    if (newPassword) {
      if (!currentPassword) {
        alert('è¯·è¾“å…¥å½“å‰å¯†ç ');
        return;
      }
      user.password = newPassword;
    }

    fetch('/api/user/update', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(user)
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                alert('è´¦å·ä¿¡æ¯æ›´æ–°æˆåŠŸ');
                // æ›´æ–°å½“å‰ç”¨æˆ·ä¿¡æ¯
                currentUser.nickname = user.nickname;
                updateUserInfo();
                // æ¸…ç©ºå¯†ç å­—æ®µ
                document.getElementById('account-current-password').value = '';
                document.getElementById('account-new-password').value = '';
                document.getElementById('account-confirm-password').value = '';
              } else {
                alert('æ›´æ–°å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('æ›´æ–°å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
  }

  // åŠ è½½å®¶åº­æˆå‘˜
  function loadFamilyMembers() {
    fetch('/api/user/family-members')
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                updateFamilyMembersTable(data.data);
              }
            })
            .catch(error => {
              console.error('Error:', error);
            });
  }

  // æ›´æ–°å®¶åº­æˆå‘˜è¡¨æ ¼
  function updateFamilyMembersTable(members) {
    const tbody = document.querySelector('#family-members tbody');
    tbody.innerHTML = '';

    members.forEach(member => {
      const row = document.createElement('tr');

      row.innerHTML = `
                    <td>${member.username}</td>
                    <td>${member.nickname}</td>
                    <td>${member.role === 'ADMIN' ? 'å®¶åº­ä¸»ç®¡' : 'å®¶åº­æˆå‘˜'}</td>
                    <td>
                        <button class="btn reset-password-btn" data-id="${member.id}">é‡ç½®å¯†ç </button>
                    </td>
                `;

      tbody.appendChild(row);
    });

    // ç»‘å®šé‡ç½®å¯†ç æŒ‰é’®äº‹ä»¶
    document.querySelectorAll('.reset-password-btn').forEach(btn => {
      btn.addEventListener('click', function() {
        const userId = parseInt(this.getAttribute('data-id'));
        resetMemberPassword(userId);
      });
    });
  }

  // åˆå§‹åŒ–å¹´ä»½å’Œæœˆä»½é€‰æ‹©å™¨
  function initDateSelectors() {
    const currentYear = new Date().getFullYear();
    const currentMonth = new Date().getMonth() + 1; // æœˆä»½ä»0å¼€å§‹

    // åˆå§‹åŒ–å¹´ä»½é€‰æ‹©å™¨ï¼ˆå·²æœ‰ï¼‰
    const yearSelectors = [
      document.getElementById('record-year'),
      document.getElementById('report-year')
    ];

    yearSelectors.forEach(selector => {
      if (selector) {
        selector.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹
        // æ·»åŠ æœ€è¿‘5å¹´çš„é€‰é¡¹
        for (let year = currentYear; year >= currentYear - 4; year--) {
          const option = document.createElement('option');
          option.value = year;
          option.textContent = year + 'å¹´';
          selector.appendChild(option);
        }
      }
    });

    // åˆå§‹åŒ–æœˆä»½é€‰æ‹©å™¨ï¼ˆæ–°å¢ï¼‰
    const monthSelectors = [
      document.getElementById('record-month'),
      document.getElementById('report-month')
    ];

    monthSelectors.forEach(selector => {
      if (selector) {
        selector.innerHTML = ''; // æ¸…ç©ºç°æœ‰é€‰é¡¹

        // å¦‚æœæ˜¯è®°å½•ç­›é€‰ï¼Œæ·»åŠ "å…¨å¹´"é€‰é¡¹
        if (selector.id === 'record-month') {
          const allYearOption = document.createElement('option');
          allYearOption.value = '0';
          allYearOption.textContent = 'å…¨å¹´';
          selector.appendChild(allYearOption);
        }

        // æ·»åŠ 1-12æœˆé€‰é¡¹
        for (let month = 1; month <= 12; month++) {
          const option = document.createElement('option');
          option.value = month;
          option.textContent = month + 'æœˆ';
          selector.appendChild(option);
        }

        // è®¾ç½®é»˜è®¤å€¼ä¸ºå½“å‰æœˆä»½
        selector.value = currentMonth;
      }
    });
  }

  // é‡ç½®æˆå‘˜å¯†ç 
  function resetMemberPassword(userId) {
    if (!confirm('ç¡®å®šè¦å°†è¯¥æˆå‘˜çš„å¯†ç é‡ç½®ä¸º123456å—ï¼Ÿ')) {
      return;
    }

    fetch(`/api/user/reset-password/${userId}`, {
      method: 'POST'
    })
            .then(response => response.json())
            .then(data => {
              if (data.code === 200) {
                alert('å¯†ç é‡ç½®æˆåŠŸ');
              } else {
                alert('é‡ç½®å¤±è´¥: ' + data.message);
              }
            })
            .catch(error => {
              console.error('Error:', error);
              alert('é‡ç½®å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•');
            });
  }

  function updateUserInfo() {
    if (currentUser) {
      document.getElementById('current-user').textContent = currentUser.nickname;
      document.getElementById('current-family').textContent = 'å®¶åº­: ' +
              (familyList.find(f => f.id === currentUser.familyId)?.name || currentUser.familyId);

      // ä¸ªäººè´¦å·é¡µé¢å¡«å……æ•°æ®
      document.getElementById('account-username').value = currentUser.username;
      document.getElementById('account-nickname').value = currentUser.nickname;
    }
  }
</script>
</body>
</html>